<%@ page contentType="text/html;charset=UTF-8" %>
<%@ include file="/WEB-INF/views/include/taglib.jsp"%>

<html>
<head>
	<title>${map.title}</title>
    <meta name="decorator" content="default"/>
    <%@ include file="/WEB-INF/views/include/treeview.jsp" %>
    <%@ include file="/WEB-INF/views/include/fileupload.jsp"%>
    <%@ include file="/WEB-INF/views/include/selectNext.jsp" %>
    <%@ include file="/static/velocitystyle/JSstyle.jsp" %>
    <script src="${pageContext.request.contextPath}/static/custom/textEditor.js" type="text/javascript"></script>
    <script src="${pageContext.request.contextPath}/static/commonUtils.js" type="text/javascript"></script>
    <link href="${pageContext.request.contextPath}/static/velocitystyle/style.css" type="text/css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="${pageContext.request.contextPath}/static/css/commonstyle.css">
    <%--<%@ include file="/WEB-INF/velocitystyle/JSstyle.jsp" %>--%>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/static/bootstraptimecss/bootstrap-datetimepicker.css" media="all">
    <script src="${pageContext.request.contextPath}/static/bootstraptime/bootstrap-datetimepicker.js"></script>
    <script src="${ctxStatic}/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
	<script type="text/javascript">
        $(function () {
			
            // 根据流程加载tree数据
            //selectNextPersonAudit();
            
            // 加载页面样式
            var modeRemark = "${map.modeRemark}";
            style(modeRemark);// 0:紧凑模式 ; 1: 非紧凑模式

            $(".a-upload").on("change","input[type='file']",function(){
                var filePath=$(this).val();
                var arr=filePath.split('\\');
                var fileName=arr[arr.length-1];
                $(".showFileName").html(fileName);
            });
            // 设置选择下一步流程窗口的高度
            //setTreeH();
            
			$("#inputForm").validate({
				submitHandler: function(form){
					loading('正在提交，请稍等...');
					form.submit();
				},
				errorContainer: "#messageBox",
				errorPlacement: function(error, element) {
					$("#messageBox").text("输入有误，请先更正。");
					if (element.is(":checkbox")||element.is(":radio")||element.parent().is(".input-append")){
						error.appendTo(element.parent().parent());
					} else {
						error.insertAfter(element);
					}
				}
			});
		});

        //提交表单方式
        function submitForm(flagTrans) {
            /***start***********************check是否有正在上传的附件**********************start***/
            if(attsUploading()){
                return;
            }
            /***end*************************check是否有正在上传的附件************************end***/
            if(flagTrans=="yes"){
                cheackForm(flagTrans);
            }else if(flagTrans=="saveData"){
                submitSaveData(flagTrans);
            }
        }

        // 根据流程加载tree数据
        <%--function selectNextPersonAudit(){--%>
        <%--var procDefKey = "${${entityName}.act.procDefKey}";--%>
        <%--var procInsId = "${${entityName}.act.procInsId}";--%>
        <%--var procdefid = "${${entityName}.act.procDefId}";--%>
        <%--var taskRelatedOption = $('#userfulWord').val().split('_');--%>
        <%--var taskdefkey = taskRelatedOption[0];--%>
        <%--var taskkey = taskRelatedOption[1];--%>

        <%--var labelName = '';--%>
        <%--var office_id="";--%>
        <%--selectAudit(procdefid,procDefKey,taskdefkey,taskkey,labelName,procInsId,office_id);--%>
        <%--}--%>
	</script>
    <style>
        #demoList a{
            float: left;
            /*  margin-right:5px;; */
            line-height:35px;
            margin-left:15px;
        }
        .cke_label{
            display:inline-block!important;
        }
        .a-upload {
            padding: 4px 10px;
            height: 25px;
            line-height: 20px;
            position: relative;
            cursor: pointer;
            color: #888;
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            *display: inline;
            *zoom: 1
        }

        .a-upload  input {
            position: absolute;
            font-size: 100px;
            right: 0;
            top: 0;
            opacity: 0;
            filter: alpha(opacity=0);
            cursor: pointer
        }

        .a-upload:hover {
            color: #444;
            background: #eee;
            border-color: #ccc;
            text-decoration: none
        }

    </style>
    <script type="text/javascript">
        $(function(){
            //$("#name").focus();

            var filename = $("#filenamelist").val();
            var filepath = $("#filepathlist").val();
            var downloadfile =$("#downloadfile").val();


            if(filename =="nofile"){
                var temphtml = $("#demoList").html()
                        + '<span style="line-height:35px">无</span>'
                $("#demoList").html(temphtml);
            }else{
                /*  var myArray1 = new Array(); */

                var  num =$('#num').val();
                filename= filename.slice(1,filename.length-1);
                var filenames  = filename.split(",");
                downloadfile= downloadfile.slice(1,downloadfile.length-1);
                var downloadfiles = downloadfile.split(",");


                for(var s=0;s<num;s++){

                    var temphtml = $("#demoList").html()
                            + '<a href="'
                            +downloadfiles[s]
                            +'"> <i style="color:blue">'
                            +filenames[s]
                            + '</i></a>&nbsp;&nbsp;&nbsp;&nbsp;'

                    $("#demoList").html(temphtml);
                }
            }
            $("#inputForm").validate({
                errorPlacement: function(error, element) {
                    if (element.is(":checkbox")||element.is(":radio")||element.parent().is(".input-append")){
                        error.appendTo(element.parent().parent());
                    } else {
                        error.appendTo(element.parent());
                    }
                }
            });

            //设置mainView高度
            setMainViewH();

            setTitleWidth("fileTitle", "mainView");
            $(window).resize(function(){
                setTitleWidth("fileTitle", "mainView");
            });


            $.ajax({
                url:'${ctx}/act/task/canWithdrawOrRetreat',
                type:'post',
                data:'taskId=${${entityName}.act.taskId}&procInstId=${${entityName}.act.procInsId}&retreatOperType=withdraw',
                dataType:'text',
                success:function(data){
                    if(data == 'can'){
                        $('#btn-withdraw').show();
                    }
                },
                error:function(){
                    alert('error');
                }
            });
            
        });
    </script>
    <script type="text/javascript">
        //对文件地址进行更新
        function updateFilePath(path, fileTypes, realPath, wordsCount) {
            //如果是word
            if(fileTypes=="0"){
                if(path!=''){
                    $("#cacheAddrDoc").val(path);
                    $("#cacheRealAddrDoc").val(realPath);
                    $("#cacheTypeDoc").val(fileTypes);
                    $("#cacheCountDoc").val(wordsCount);
                }else{
                    if($("#cacheAddrDoc").val() != ''){
                        $("#textAddr").val($("#cacheAddrDoc").val());
                    }
                    $("#textType").val("0");
                    if($("#cacheRealAddrDoc").val() != ''){
                        $("#textRealurl").val($("#cacheRealAddrDoc").val());
                    }
                    $("#wordsCount").val(wordsCount);
                }
                //如果是Excel
            }else if(fileTypes=="1"){
                //如果地址为空则为更新文件
                if(path!=''){
                    $("#cacheAddrExcel").val(path);
                    $("#cacheRealAddrExcel").val(realPath);
                    $("#cacheTypeExcel").val(fileTypes);
                    //更新保存数据库的input
                }else{
                    if($("#cacheAddrExcel").val() != ''){
                        $("#textAddr").val($("#cacheAddrExcel").val());
                    }
                    $("#textType").val("1");
                    if($("#cacheRealAddrExcel").val() != ''){
                        $("#textRealurl").val($("#cacheRealAddrExcel").val());
                    }

                    $("#wordsCount").val(wordsCount);
                }
            }
            if(path!=''){
                $("#textAddr").val(path);
                var cacheAddr=$("#cacheAddr").val();
                if(cacheAddr!=""){
                    $("#cacheAddr").val(cacheAddr+","+path);
                }else{
                    $("#cacheAddr").val(path);
                }
                $("#textType").val(fileTypes);
                $("#textRealurl").val(realPath);
                $("#wordsCount").val(wordsCount);
            }
        }
        // TODO
        function updateFileContent(content, fileTypes) {
            $("#textContent").val(content);
            $("#textType").val(fileTypes);
        }
        //打印
        function download(){
            /***start***********************check是否有正在上传的附件**********************start***/
            if(attsUploading()){
                return;
            }
            /***end*************************check是否有正在上传的附件************************end***/
            $("#fileTitle").removeClass("required");
            $("#secrets").removeClass("required");
            $("#referenceNum").removeClass("required");
            $("#fileType").removeClass("required");
            document.getElementById("inputForm").action="${ctx}/commonly_text_all/commonlyText/downLoad?type=1";
            $("#inputForm").submit();
            $("#fileTitle").addClass("required");
            $("#secrets").addClass("required");
            $("#referenceNum").addClass("required");
            $("#fileType").addClass("required");

        }

        function setNextStep(nextStep, assignee){
            $("#assignee").val(assignee);
            $("#nextStep").val(nextStep);
        }
        function wClose(){
            window.close();
        }
        function refreshList(){
            window.location = '${ctx}/act/task/historic';
        }

        <%--function takeBack(){
            var procInsId="${procInsId}";
            var productTag="${productTag}";
            top.$.jBox.confirm("确认收回吗？","提示信息",function(v,h,f){
                        if(v=="ok"){
                            document.getElementById("inputForm").action="${ctx}/${package}/takeBack?procInsId="+procInsId+"&productTag="+productTag;
                            $("body").mLoading("show");
                            $("#inputForm").submit();
                        }
                    },
                    {top: '15%'});
            return false;
        }--%>

        function withdrawOrRetreatOper(oper){
            if(!confirm('是否确认要进行收回操作？')){
                return false;
            }
            $.ajax({
                url:'${ctx}/act/task/withdrawOrRetreatOper',
                type:'post',
                data:'taskId=${${entityName}.act.taskId}&procInstId=${${entityName}.act.procInsId}&retreatOperType='+oper,
                dataType:'text',
                success:function(data){
                    if (data == 'success') {
                        window.location = '${ctx}/act/task/historic?messagetag=2';
                    }
                },
                error:function(){
                    alert('收回失败,请稍后再试.');
                }
            });
        }
        
        function history(){
            var proc_Ins_Id = arguments[0];
            $.get('${ctx}/act/task/histoicFlowSimple',{procInsId:proc_Ins_Id},function(data){
                $('#historybody').html(data);
            });
            $("#myModal").modal({backdrop: 'static', keyboard: false});
            $('#myModal').modal('show');
        }

    </script>
    <style type="text/css">
        #phone{
            background:url("${pageContext.request.contextPath}/static/jquery-validation/1.11.1/images/unchecked.gif") no-repeat 0px 0px;
            padding-left: 18px;
            padding-bottom: 2px;
            font-weight: bold;
            color: #EA5200;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<ul id="headView" class="nav nav-tabs">
	<li class="active">
		<a style="font-size:15px;font-weight:bold;width:auto;padding: 15px 10px;">
				<span style="padding: 8px;background-repeat:repeat-x;background-size:cover;background-image:url('${pageContext.request.contextPath}/images/shadow.png');border-radius:5px;">
					${map.title}
				</span>
		</a>
	</li>
    <div id="buttonDiv" style="float: right;margin-right: 3%;margin-top: 10px">
##        <c:if test="${fns:getUser().id eq createBy }">
##            <input id="takeBack"  class="btn btn-danger"  type="button" value="收  回" onclick="takeBack()" />
##            &nbsp;&nbsp;&nbsp;&nbsp;
##        </c:if>w
        <!-- <input id="btnCancel" class="btn" style="background: #F3F3F3; color: black;" type="button" value="返  回" onclick="refreshList()" /> -->
    <button class="btn btn-warning" id="btn-withdraw" onclick="withdrawOrRetreatOper('withdraw')">收      回</button> &nbsp;&nbsp;
    <!--<button class="btn btn-danger" id="btn-retreat" onclick="withdrawOrRetreatOper('retreat')">退      回</button> &nbsp;&nbsp;-->
    <button class="btn btn-primary" onclick="history('${${entityName}.act.procInsId}');">流转历史</button> &nbsp;&nbsp;&nbsp;&nbsp;
        <button class="btn btn-warning" onclick="refreshList()">返  回</button>
    </div>
    <script type="text/javascript">
        (function(){
            $('#btn-withdraw').hide();
            $('#btn-retreat').hide();
        })();
    </script>
</ul>
<div id="mainView" style="overflow-y: auto;height:0px;float: left;width: 75%;">
	<form:form id="inputForm" modelAttribute="${map.entityName}" name="form"
			   action="${ctx}/${map.package}/${map.entityName}/" method="post"
			   class="form-horizontal" enctype="multipart/form-data">
		<div style="width: 75%">${map.formView}</div>
        <form:hidden path="id" />
        <form:hidden path="act.taskId" />
        <form:hidden path="act.taskName" />
        <form:hidden path="act.taskDefKey" />
        <form:hidden path="act.procInsId" />
        <form:hidden path="act.procDefId" />
        <form:hidden id="flagTrans" path="act.flagTrans" />
        <sys:message content="${message}" />

        <input type="hidden" id="cacheAddr"/><!-- 历史缓存地址 -->
        <input type="hidden" id="cacheAddrDoc"/><!-- word历史缓存地址 -->
        <input type="hidden" id="cacheAddrExcel"/><!-- Excel历史缓存地址 -->
        <input type="hidden" id="cacheRealAddrDoc"/><!-- word历史缓存实际地址 -->
        <input type="hidden" id="cacheRealAddrExcel"/><!-- Excel历史缓存实际地址 -->
        <input type="hidden" id="cacheTypeDoc"/><!-- word历史缓存文件类型 -->
        <input type="hidden" id="cacheTypeExcel"/><!-- Excel历史缓存文件类型 -->
        <input type="hidden" id="cacheCountDoc"/><!-- doc历史缓存字数 -->

        <!-- 查询条件 -->
        <input name="procDefKey_s" type="hidden" value="${procDefKey_s}"/>
        <input name="secretType_s" type="hidden" value="${secretType_s}"/>
        <input name="beginDate_s" type="hidden" value="${beginDate_s}"/>
        <input name="endDate_s" type="hidden" value="${endDate_s}"/>
        <input name="pageNo_s" type="hidden" value="${pageNo_s}"/>
        <input name="pageSize_s" type="hidden" value="${pageSize_s}"/>
        <input name="title_s" type="hidden" value="${title_s}"/>
        <input name="referenceNum_s" type="hidden" value="${referenceNum_s}"/>
        <input name="isDoData_s" type="hidden" value="${isDoData_s}"/>
        <input id="filepathlist" type="hidden" value="${filepathlist}"/>
        <input id="filenamelist" type="hidden" value="${filenamelist}"/>
        <input id="downloadfile" type="hidden" value="${dowmloadfile}"/>
        <input id="num" type="hidden" value="${num}"/>
        <!-- 下一步骤 -->
        <form:input type="hidden" id="nextStep" path="act.flag" value=""/>
        <!-- 下一步负责人 -->
        <form:input type="hidden" id="assignee" path="act.assignee" value=""/>
	</form:form>
</div>
<div class="modal fade" id="myModal" style="top:10%;display:none;width:700px;position:fixed;left:40%;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">流转历史</h4>
            </div>
            <div class="modal-body" style="max-height:300px;" id="historybody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>